# Тестирование плагина Ассистент для Obsidian

Документ про ручное тестирование в реальном vault + подсказки для прогона UI (в т.ч. через remote debugging).

# Использовать данные для тестирования

Календарь gernovich.v@gigwork.ru актуальный, текущие встречи удалять нельзя (можно создать тестовую встречу и её удалить).
Плагин в Obsidian ещё не запущен в бой, поэтому его данные можно удалять.
Путь к заметкам: `/home/gernovich/notes`
Заметки в Obsidian боевые — их удалять нельзя (можно создать тестовую заметку и её удалить).

Данные плагина `/home/gernovich/notes/Ассистент` не боевые, их можно удалять

---

# Fast path (CLI) — чтобы прогон был быстрее

Если цель прогона — только проверить установку/создание структуры (без UI), используем быстрые проверки:

- Сборка+установка:
  - `npm run build && npm run install:obsidian`
- Очистка данных плагина в vault:
  - `rm -rf /home/gernovich/notes/Ассистент`
- После запуска Obsidian и включения плагина (или если плагин автозапускается) проверить структуру:
  - `ls -la /home/gernovich/notes/Ассистент`
  - `find /home/gernovich/notes/Ассистент -maxdepth 2 -type d -print`
  - `find /home/gernovich/notes/Ассистент -maxdepth 1 -type f -name '*.base' -print`

PASS, если существуют папки:

- `/home/gernovich/notes/Ассистент/Встречи`
- `/home/gernovich/notes/Ассистент/Протоколы`
- `/home/gernovich/notes/Ассистент/Люди`
- `/home/gernovich/notes/Ассистент/Проекты`

И `.base` файлы:

- `/home/gernovich/notes/Ассистент/Встречи.base`
- `/home/gernovich/notes/Ассистент/Протоколы.base`
- `/home/gernovich/notes/Ассистент/Люди.base`
- `/home/gernovich/notes/Ассистент/Проекты.base`

---

# Запуск Obsidian для MCP (remote debugging)

Чтобы агент мог управлять UI и делать скриншоты, Obsidian нужно запускать с remote debugging:

- Команда (пример):
  - `nohup /home/gernovich/apps/obsidian/Obsidian-1.10.6.AppImage --remote-debugging-port=9222 </dev/null >/tmp/obsidian-mcp.log 2>&1 & disown`
- Проверка порта:
  - `ss -ltnp | grep 9222`
- Если окно не находится MCP сразу — подождать 3–5 секунд и повторить.

---

# Артефакты прогона (что прикладывать)

- Скриншот: Settings → **Сторонние плагины** → плагин **“Ассистент” включён** (тумблер ON)
- Скриншот: левое дерево файлов → видна папка `Ассистент/`
- (Опционально) логи developer console (последние ~50 строк) без секретов

---

# Troubleshooting (быстро)

- MCP не видит окно:
  - убедиться, что Obsidian запущен с `--remote-debugging-port=9222`
  - убедиться, что порт слушается: `ss -ltnp | grep 9222`
  - перезапустить Obsidian (иногда нужно подождать несколько секунд после старта)

---

# Troubleshooting: логирование (самый быстрый путь к диагнозу)

Если “что-то пошло не так”, действуем так:

- **Открыть лог**:
  - команда `Ассистент: Открыть лог` (in-memory)
  - или файл `<vault>/.obsidian/plugins/assistant/logs/YYYY-MM-DD.log` (для истории)
- **Найти последний полный цикл**:
  - ищем `Sync: refreshCalendarsAndSync: старт` и соответствующее завершение `... ok / ... stale / ... с ошибками`
  - обращаем внимание на `opId` (связывает старт/финиш), `durationMs`, `stale` и `errors`
- **Если проблема в записи (Linux Native)**:
  - включить `Debug` в настройках ассистента (`debug.enabled=true`)
  - повторить действие: в логе появятся более подробные строки про `pactl`/источники/запуск `ffmpeg`

# Юнит‑тесты и coverage (CI‑стиль)

- Запуск тестов:
  - `npm test`
- Coverage:
  - `npm run test:coverage`

# Тестсьют "Основные функции"

## Тесткейс "Запуск"

**Цель**: убедиться, что плагин устанавливается, включается и создаёт базовую структуру в vault без ошибок.

**Предусловия**:

- Vault: `/home/gernovich/notes`
- Данные плагина в vault не боевые: `/home/gernovich/notes/Ассистент` (можно удалять)

**Шаги**:

- Собрать и установить плагин в Obsidian:
  - `npm run build && npm run install:obsidian`
- Очистить данные плагина в vault (только папку ассистента):
  - `rm -rf /home/gernovich/notes/Ассистент`
- Запустить Obsidian и открыть vault `/home/gernovich/notes`
- Открыть Settings → Community plugins
- Убедиться, что **плагин "Ассистент" включён**

**Ожидаемый результат**:

- Obsidian запускается без ошибок/крашей
- Плагин включается без ошибок
- В vault появляется папка: `/home/gernovich/notes/Ассистент`
- Внутри создаются базовые папки/файлы (минимум):
  - `Ассистент/Встречи/`
  - `Ассистент/Протоколы/`
  - `Ассистент/Люди/`
  - `Ассистент/Проекты/`
  - `Ассистент/Встречи.base`, `Ассистент/Протоколы.base`, `Ассистент/Люди.base`, `Ассистент/Проекты.base` (если их не было)
- Внутри Obsidian нет заметных ошибок в UI (и нет красных ошибок в Console, если открывать DevTools)

**Результаты прогонов**:

- Валентин 2026-01-20 22:35:09 ✅
- GPT-5.2 2026-01-20 22:49:51 ✅

## Тесткейс "Повестка: обновление календарей → карточки встреч"

**Цель**: проверить refresh календарей и создание/обновление карточек встреч в vault.

**Предусловия**:

- Плагин включён (см. "Запуск")
- В Settings → Ассистент:
  - подключён хотя бы один календарь (ICS URL или CalDAV)
  - включены папки по умолчанию (или задана папка встреч)

**Шаги**:

- Открыть view "Повестка" (команда: `Ассистент: Открыть повестку`)
- Нажать `Сегодня`, убедиться, что вид отрисовался
- Нажать `Ассистент: Обновить календари` (command palette)
- Дождаться завершения refresh (события появились/обновились)
- Кликнуть по любому событию в повестке

**Ожидаемый результат**:

- В повестке отображаются события дня (если они есть в календаре)
- При клике по событию создаётся/открывается карточка встречи в `Ассистент/Встречи/`
- В карточке встречи корректный frontmatter (минимум):
  - `assistant_type: calendar_event`
  - `calendar_id`, `event_id`, `summary`, `start`
- Повторный клик по тому же событию открывает **тот же файл** (идентичность через `(calendar_id, event_id)`)

## Тесткейс "RSVP (CalDAV): изменить статус из повестки и проверить синхронизацию"

**Цель**: убедиться, что статус участия меняется в календаре (write-back) и отображается в повестке.

**Предусловия**:

- Подключён CalDAV календарь (не ICS URL), где доступны изменения RSVP
- В настройках задан `myEmail` (может быть несколько через `,`/пробел/`;`) или аккаунт CalDAV имеет корректный `username`
- Есть событие, где вы участник (ATTENDEE) и статус можно менять

**Шаги**:

- В "Повестке" найти событие и открыть контекстное меню (ПКМ по событию)
- Выбрать по очереди:
  - `Принято`
  - затем `Отклонено` (или `Возможно`)
- После каждого выбора подождать пару секунд и нажать refresh (если нужно)
- (Опционально) открыть веб/десктоп Google Calendar и убедиться, что RSVP изменился там

**Ожидаемый результат**:

- В повестке статус меняется **сразу** (оптимистично) и затем подтверждается после refresh
- Для CalDAV статус реально записывается в календарь (после refresh виден тот же статус)
- Для ICS URL календаря при попытке изменения должен быть понятный отказ (read-only)

---

## Тесткейс "Диктофон: запись → пауза завершает файл → продолжить начинает новый файл"

**Цель**: подтвердить семантику записи и нарезки файлов.

**Предусловия**:

- Плагин включён
- Открыт диалог `Ассистент: Диктофон`

**Шаги**:

- Нажать REC (начать запись)
- Подождать 3–5 секунд
- Нажать **Пауза**
- Убедиться, что в `Ассистент/Записи/` появился **новый файл** (чанк)
- Нажать **Продолжить**
- Подождать 3–5 секунд
- Нажать **Стоп**

**Ожидаемый результат**:

- После паузы создаётся/дописывается текущий файл записи
- После продолжения запись идёт в **новый** файл
- После стопа текущий файл гарантированно дописывается

---

## Тесткейс "Диктофон + Новый протокол: файлы прикрепляются в протокол (`files:`)"

**Цель**: убедиться, что записанные аудио‑файлы автоматически добавляются в протокол.

**Предусловия**:

- В диалоге диктофона включён **Новый протокол**

**Шаги**:

- Запустить запись (REC)
- Подождать 3–5 секунд
- Поставить на паузу или остановить запись
- Открыть созданный протокол (md)

**Ожидаемый результат**:

- В frontmatter протокола поле `files` содержит пути на аудио‑файлы из `Ассистент/Записи/`

---

## Тесткейс "Транскрибация (Nexara): файл записи → расшифровка в протокол"

**Цель**: убедиться, что фоновые задачи Nexara находят прикреплённые записи и добавляют расшифровку в протокол с таймингами.

**Предусловия**:

- В Settings → Ассистент → **Транскрибация (Nexara)**:
  - включено `enabled`
  - задан `token`
- Есть протокол, к которому прикреплён хотя бы один файл записи (frontmatter `files: [...]`)

**Шаги**:

- Открыть протокол (md) и убедиться, что секция `### Расшифровка` пока пустая/шаблонная
- Подождать один цикл фонового опроса (по умолчанию 20 минут) **или** временно уменьшить `pollMinutes` до 1 и подождать ~1–2 минуты
- Обновить/переоткрыть протокол

**Ожидаемый результат**:

- В секции `### Расшифровка` появляется блок вида:
  - `#### Расшифровка: <имя файла>`
  - строки `- 00:00.000–00:05.120 ...`
- В frontmatter протокола поле `transcript` содержит JSON-массив путей уже расшифрованных файлов

---

## Тесткейс "Протоколы: раскладка по подпапкам встречи (фиксированная политика)"

**Цель**: убедиться, что новые протоколы создаются в ожидаемых папках по **фиксированной** политике (без настройки).

**Предусловия**:

- Плагин включён
- В Settings → Ассистент → **Папки в vault** настроены стандартно (или задана папка протоколов).

**Шаги**:

- Открыть любую встречу из “Повестки” (создать карточку встречи кликом, если нужно)
- Выполнить действие “Создать протокол” (из контекстного меню встречи или команда “Встреча: создать протокол из открытой карточки”)
- В дереве файлов проверить, где появился новый файл протокола
- Выполнить команду `Ассистент: Создать карточку протокола` (manual протокол)
- Проверить, где появился manual протокол

**Ожидаемый результат**:

- Протокол встречи создаётся в `Ассистент/Протоколы/<basename карточки встречи>/...`
- Manual протокол создаётся в `Ассистент/Протоколы/...`
- Существующие протоколы не “переезжают” автоматически (миграции нет)

---

## Тесткейс "Уведомление в момент начала: авто‑открытие диктофона (по умолчанию включено)"

**Цель**: убедиться, что при старте встречи плагин открывает диктофон автоматически (и там есть обратный отсчёт авто‑записи).

**Предусловия**:

- В Settings → Ассистент → **Уведомления**:
  - включено “в момент начала” (`atStart`)
- В Settings → Ассистент → **Запись**:
  - **Авто запись (если встреча уже идёт)** включена (по умолчанию включена)
  - тайминг авто записи = 5 сек (или любой > 0)

**Шаги**:

- Создать тестовую встречу, которая начнётся через 1–2 минуты (можно в отдельном тест‑календаре)
- Дождаться момента начала встречи

**Ожидаемый результат**:

- Открывается окно диктофона
- В окне видно обратный отсчёт и авто‑нажатие REC
- (Опционально) отдельное окно “Встреча началась” может не появиться, т.к. диктофон открывается сразу
