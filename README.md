## Плагин Ассистент для Obsidian

Плагин Obsidian для отработки технологии: календарь (ICS), повестка, уведомления, логирование и синхронизация встреч в заметки.

### Цель

Цель — автоматизировать “операционку” вокруг встреч и знаний, чтобы затем перейти к тактическим и стратегическим сценариям:

- **Операционный уровень**: календарь → встречи → протоколы → запись → расшифровка → извлечение знаний (окраска, обещания, проекты, люди, пониание голосов)
- **Тактический уровень**: проекты/задачи/внедрение (из встреч)
- **Стратегический уровень**: планы и экономия времени/денег

> Примечание: термин “расшифровка” здесь = транскрипция речи (ASR). В UI диктофона используем “Расшифровано”.

### Scope

- Сейчас делаем **только Linux**.
- Vault синхронизируется через **приватный git** (в том числе на телефоне).

### AI-стек (план)

- На старте: **облачные** сервисы для AI/ASR/voiceprint (быстрее запуститься).
- Позже: **локально** (по мере опыта) — например **Ollama** + единый OpenAI-compatible endpoint (вроде Continue server), который можно подключать к Obsidian Copilot.

### Установка зависимостей

```bash
npm i
```

### Зависимости для всплывающего окна уведомлений (Linux)

Сейчас уведомления показываются через **electron_window** (встроенное окно поверх всех) и **не требуют внешних бинарников** вроде `yad`/`notify-send`.

### Тесты и coverage

```bash
npm test
```

Coverage (P2, с минимальными порогами):

```bash
npm run test:coverage
```

### Уведомления: проверка зависимостей

Уведомления реализованы как **electron_window** + fallback на `Notice` (если `BrowserWindow` недоступен в окружении).

### Сборка

```bash
npm run build
```

В результате появится папка `dist/` — это формат, который Obsidian ожидает от плагина (внутри будут `main.js`, `manifest.json`, `styles.css`).

### Быстрый цикл “собрать + установить в Obsidian”

Если плагин установлен в vault через скрипт `install:obsidian`, удобнее всего:

```bash
npm run build && npm run install:obsidian
```

### Dev-режим (watch)

```bash
npm run dev
```

### Установка в Obsidian (автоматически)

Скопирует содержимое `dist/` в `/home/gernovich/notes/.obsidian/plugins/assistant/`.

```bash
npm run install:obsidian
```

### Установка в Obsidian (ручной способ)

- Найди папку хранилища: `<vault>/.obsidian/plugins/`
- Создай папку плагина, например: `<vault>/.obsidian/plugins/assistant/`
- Скопируй туда файлы:
  - `dist/manifest.json`
  - `dist/main.js`
  - `dist/styles.css` (опционально)
- В Obsidian открой Settings → Community plugins и включи плагин.

### Настройка календаря (ICS URL)

- Возьми ссылку **Secret address in iCal format** (приватная, с токеном) и вставь в Settings плагина в календарь типа **ICS URL**.

### Настройка календаря (CalDAV) — MVP

В Settings плагина → **CalDAV**:

- добавь аккаунт (Server URL / login / app password)
- нажми **“Найти календари”**
- нажми **“Добавить”** на нужном календаре (он появится в списке “Календари”)

Важно:

- Данные CalDAV (включая пароль) хранятся локально в `.obsidian/plugins/assistant/data.json`. По умолчанию `.obsidian` не синхронизируется через git — это правильно.
- Поддерживаются **Basic auth** и **Google OAuth**:
  - Basic: логин + пароль (для Google обычно нужен **App password**, зависит от аккаунта/политик).
  - Google OAuth: без пароля, через `refresh_token`.

### Google CalDAV без Basic (OAuth) — MVP

В Settings плагина → **CalDAV** → аккаунт:

- выбери **Auth method: Google OAuth**
- заполни `clientId` / `clientSecret`
- нажми **“Авторизоваться”** (плагин откроет браузер и поймает callback на `127.0.0.1`)

После этого `refresh_token` сохранится локально и CalDAV будет работать без пароля.

### Качество (typecheck / форматирование)

```bash
npm run typecheck
npm run format
npm run format:check
```

### CalDAV (Google) — нюансы, на которые мы напоролись

- **Server URL для Google CalDAV v2 фиксированный**: используем **только** `https://apidata.googleusercontent.com/caldav/v2/` (без email в конце).
  - Если поставить `.../caldav/v2/<email>/`, `tsdav` может падать в discovery с `cannot find homeUrl` или давать “пустые” результаты.
- **Нужно включить именно “CalDAV API” в Google Cloud проекте**, где создан OAuth Client ID.
  - “Google Calendar API” **не** заменяет “CalDAV API” для этих запросов.
  - Типичная ошибка: `accessNotConfigured` (403) — обычно помогает включить “CalDAV API” и подождать 5–10 минут.
- **Выбор календаря**: discovery может вернуть несколько календарей (например основной и “Праздники”).
  - Для встреч обычно нужен календарь с displayName = ваш email (например `✅ Основной: gernovich.v@gigwork.ru`).
- **“0 событий без ошибки”**: для неверного `calendarUrl` (опечатка в email, устаревший URL) Google может вернуть 0 объектов без явного exception.
  - Решение: переподключить календарь через **“Найти календари”** и добавить заново.
- **App password**: Google часто показывает его с пробелами, но вводить нужно **без пробелов** (16 символов подряд).

### Что создаётся в vault (по умолчанию, настраивается)

- `Ассистент/Встречи/` — md‑встречи календаря (повторяющиеся живут в одном файле)
- `Ассистент/Протоколы/` — md‑протоколы (пока заготовка)
- `Ассистент/Люди/`, `Ассистент/Проекты/` — карточки (пока заготовка)
- `Ассистент/Встречи.base`, `Ассистент/Протоколы.base`, `Ассистент/Люди.base`, `Ассистент/Проекты.base` — YAML для встроенного плагина Obsidian “Базы данных / Bases” (табличные представления по `file.inFolder("...")`).

### Где лежат лог‑файлы

Чтобы не засорять дерево заметок лишними файлами, **лог‑файлы хранятся в служебной папке Obsidian**:

- `<vault>/.obsidian/plugins/assistant/logs/` — логи по датам (например `2026-01-20.log`)

### Телефон / оффлайн встречи

Идея потока:

- **запись на телефоне** (в дороге/оффлайн)
- **git sync**
- **обработка на ПК** (саммари/факты/участники/привязки)

### Команды (Command palette)

- `Ассистент: Открыть повестку`
- `Ассистент: Открыть лог`
- `Ассистент: Обновить календари`
- `Ассистент: Создать карточку встречи`
- `Ассистент: Создать карточку протокола`
- `Ассистент: Встреча: создать протокол из открытой карточки`
- `Ассистент: Создать карточку человека`
- `Ассистент: Создать карточку проекта`
- `Ассистент: Встреча: создать карточки людей из участников`
- `Ассистент: Применить офлайн-очередь`
- `Ассистент: Статус: Принято (в календаре, из заметки встречи)`
- `Ассистент: Статус: Отклонено (в календаре, из заметки встречи)`
- `Ассистент: Статус: Возможно (в календаре, из заметки встречи)`
- `Ассистент: Статус: Нет ответа (в календаре, из заметки встречи)`

### Диктофон (запись разговора)

- **Где лежат аудио-файлы**: `Ассистент/Записи/` (в vault).
- **Нарезка на файлы**: каждые `recording.chunkMinutes` минут (по умолчанию 5).
- **Семантика паузы**:
  - “Пауза” **завершает текущий файл** (файл гарантированно дописывается).
  - “Продолжить” **начинает новый файл**.
- **Закрытие окна**: если запись идёт — она останавливается и текущий файл дописывается.
- **Протокол + файлы**:
  - если при старте записи создан “Новый протокол”, то каждый записанный файл автоматически добавляется в frontmatter протокола `files: [...]`.
- **Формат**: по умолчанию пишем аудио в `audio/webm` (обычно Opus). Настройки выбора формата нет (mp3 потребует отдельной конвертации после записи).

### Встречи: участники и статус

- В карточке встречи хранится список `attendees` (email + CN + PARTSTAT), а также агрегаты `attendees_*` (сколько “придёт/не придёт/не указал”).
- Поле `my_partstat` — это ваш статус участия из календаря (PARTSTAT/RSVP): Принято/Отклонено/Возможно/Нет ответа. В CalDAV его можно менять из повестки (write-back).

### Важно (git + приватные токены)

Если vault синхронизируется через git:

- **Не синхронизируй `.obsidian/`**. Это локальные настройки Obsidian (на разных установках/на телефоне могут быть другие плагины и другая конфигурация).
  - Рекомендуемый `.gitignore` для vault:
    - `.obsidian`
- **Настройки плагинов тоже должны быть локальными** (обычно лежат в `.obsidian/plugins/...`), например:
  - `<vault>/.obsidian/plugins/assistant/data.json` (там могут быть приватные ICS URL с токенами)
  - `<vault>/.obsidian/plugins/assistant/logs/` (лог‑файлы)
