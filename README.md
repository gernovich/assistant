## Плагин Ассистент для Obsidian

Плагин Obsidian для отработки технологии: календарь, повестка, уведомления, логирование и синхронизация встреч в заметки.

### Цель

Цель — автоматизировать “операционку” вокруг встреч и знаний, чтобы затем перейти к тактическим и стратегическим сценариям:

- **Операционный уровень**: календарь → встречи → протоколы → запись → расшифровка → извлечение знаний (окраска, обещания, проекты, люди, понимание голосов)
- **Тактический уровень**: проекты/задачи/внедрение (из встреч)
- **Стратегический уровень**: планы и экономия времени/денег

> Примечание: термин “расшифровка” здесь = транскрипция речи (ASR). В UI диктофона используем “Расшифровано”.

### Scope

- Сейчас делаем **только Linux**.
- Vault синхронизируется через **приватный git** (в том числе на телефоне).

### AI-стек (план)

- На старте: **облачные** сервисы для AI/ASR/voiceprint (быстрее запуститься).
- Позже: **локально** (по мере опыта) — например **Ollama** + единый OpenAI-compatible endpoint (вроде Continue server), который можно подключать к Obsidian Copilot.

### Установка зависимостей

```bash
npm i
```

### Версии окружения

**Проверенные версии** (на момент разработки):

- **Electron**: 37.10.2
- **Node.js**: 22.21.1
- **Chrome**: 138.0.7204.251
- **Obsidian**: 1.10.6
- **Платформа**: Linux (x64)

### Зависимости для всплывающего окна уведомлений (Linux)

Сейчас уведомления показываются через **electron_window** (встроенное окно поверх всех) и **не требуют внешних бинарников** вроде `yad`/`notify-send`.

### Тесты и coverage

```bash
npm test
```

Coverage (P2, с минимальными порогами):

```bash
npm run test:coverage
```

### Уведомления: проверка зависимостей

Уведомления реализованы как **electron_window** + fallback на `Notice` (если `BrowserWindow` недоступен в окружении).

### Зависимости для записи через GStreamer

Используем `gst-kit`: https://github.com/repugraf/gst-kit  
Минимальная установка (Ubuntu/Debian):

```bash
sudo apt update
sudo apt install -y gstreamer1.0-tools gstreamer1.0-plugins-base gstreamer1.0-plugins-good
```

### Сборка

```bash
npm run build
```

В результате появится папка `dist/` — это формат, который Obsidian ожидает от плагина (внутри будут `main.js`, `manifest.json`, `styles.css`).

### Быстрый цикл “собрать + установить в Obsidian”

Если плагин установлен в vault через скрипт `install:obsidian`, удобнее всего:

```bash
npm run build && npm run install:obsidian
```

### Dev-режим (watch)

```bash
npm run dev
```

### Установка в Obsidian (автоматически)

Скопирует содержимое `dist/` в `/home/gernovich/notes/.obsidian/plugins/assistant/`.

```bash
npm run install:obsidian
```

### Установка в Obsidian (ручной способ)

- Найди папку хранилища: `<vault>/.obsidian/plugins/`
- Создай папку плагина, например: `<vault>/.obsidian/plugins/assistant/`
- Скопируй туда файлы:
  - `dist/manifest.json`
  - `dist/main.js`
  - `dist/styles.css` (опционально)
- В Obsidian открой Settings → Community plugins и включи плагин.

### Настройка календаря (ICS URL)

- Возьми ссылку **Secret address in iCal format** (приватная, с токеном) и вставь в Settings плагина в календарь типа **ICS URL**.

### Настройка календаря (CalDAV) — MVP

В Settings плагина → **CalDAV**:

- добавь аккаунт (Server URL / login / app password)
- нажми **“Найти календари”**
- нажми **“Добавить”** на нужном календаре (он появится в списке “Календари”)

Важно:

- Данные CalDAV (включая пароль) хранятся локально в `.obsidian/plugins/assistant/data.json`. По умолчанию `.obsidian` не синхронизируется через git — это правильно.
- Поддерживаются **Basic auth** и **Google OAuth**:
  - Basic: логин + пароль (для Google обычно нужен **App password**, зависит от аккаунта/политик).
  - Google OAuth: без пароля, через `refresh_token`.

### Google CalDAV без Basic (OAuth) — MVP

В Settings плагина → **CalDAV** → аккаунт:

- выбери **Auth method: Google OAuth**
- заполни `clientId` / `clientSecret`
- нажми **“Авторизоваться”** (плагин откроет браузер и поймает callback на `127.0.0.1`)

После этого `refresh_token` сохранится локально и CalDAV будет работать без пароля.

### Качество (typecheck / форматирование)

```bash
npm run typecheck
npm run format
npm run format:check
```

### CalDAV (Google) — нюансы, на которые мы напоролись

- **Server URL для Google CalDAV v2 фиксированный**: используем **только** `https://apidata.googleusercontent.com/caldav/v2/` (без email в конце).
  - Если поставить `.../caldav/v2/<email>/`, `tsdav` может падать в discovery с `cannot find homeUrl` или давать “пустые” результаты.
- **Нужно включить именно “CalDAV API” в Google Cloud проекте**, где создан OAuth Client ID.
  - “Google Calendar API” **не** заменяет “CalDAV API” для этих запросов.
  - Типичная ошибка: `accessNotConfigured` (403) — обычно помогает включить “CalDAV API” и подождать 5–10 минут.
- **Выбор календаря**: discovery может вернуть несколько календарей (например основной и “Праздники”).
  - Для встреч обычно нужен календарь с displayName = ваш email (например `✅ Основной: gernovich.v@gigwork.ru`).
- **“0 событий без ошибки”**: для неверного `calendarUrl` (опечатка в email, устаревший URL) Google может вернуть 0 объектов без явного exception.
  - Решение: переподключить календарь через **“Найти календари”** и добавить заново.
- **App password**: Google часто показывает его с пробелами, но вводить нужно **без пробелов** (16 символов подряд).

### Что создаётся в vault (по умолчанию, настраивается)

- `Ассистент/Встречи/` — md‑встречи календаря (повторяющиеся живут в одном файле)
- `Ассистент/Протоколы/` — md‑протоколы
  - протоколы встреч всегда создаются в подпапке по **basename карточки встречи**: `Ассистент/Протоколы/<basename карточки встречи>/...`
  - протоколы без встречи (ручной старт) создаются прямо в `Ассистент/Протоколы/...`
  - важно: влияет только на **новые** протоколы, существующие файлы не мигрируются автоматически
- `Ассистент/Люди/`, `Ассистент/Проекты/` — карточки (пока заготовка)
- `Ассистент/Встречи.base`, `Ассистент/Протоколы.base`, `Ассистент/Люди.base`, `Ассистент/Проекты.base` — YAML для встроенного плагина Obsidian “Базы данных / Bases” (табличные представления по `file.inFolder("...")`).

### Где лежат лог‑файлы

Чтобы не засорять дерево заметок лишними файлами, **лог‑файлы хранятся в служебной папке Obsidian**:

- `<vault>/.obsidian/plugins/assistant/logs/` — логи по датам (например `2026-01-20.log`)

### Логи: как быстро разобраться “что пошло не так”

Если что-то работает не так, начинаем не с “долить логов везде”, а с чтения уже существующих:

- **Шаг 1 — открой лог**:
  - в Obsidian: команда `Ассистент: Открыть лог`
  - или файл: `<vault>/.obsidian/plugins/assistant/logs/YYYY-MM-DD.log`
- **Шаг 2 — найди операцию и её итог**:
  - для фонового обновления: блоки `Sync: refreshCalendarsAndSync: ...`
  - смотри `opId`, `durationMs`, `events`, `notesSynced`, и списки `stale/errors`
- **Шаг 3 — если нужна детализация**:
  - включи `debug.enabled` в настройках ассистента (Settings → Ассистент → Debug)
  - это включает более подробные диагностические логи (например для Linux Native записи: pactl/источники/аргументы ffmpeg)
- **Шаг 4 — безопасность**:
  - логи автоматически маскируют токены/пароли/секреты (redaction), поэтому их можно прикладывать к разбору, но всё равно проверяй глазами перед публикацией.

### Телефон / оффлайн встречи

Идея потока:

- **запись на телефоне** (в дороге/оффлайн)
- **git sync**
- **обработка на ПК** (саммари/факты/участники/привязки)

### Команды (Command palette)

- `Ассистент: Открыть повестку`
- `Ассистент: Открыть лог`
- `Ассистент: Обновить календари`
- `Ассистент: Создать карточку встречи`
- `Ассистент: Создать карточку протокола`
- `Ассистент: Встреча: создать протокол из открытой карточки`
- `Ассистент: Создать карточку человека`
- `Ассистент: Создать карточку проекта`
- `Ассистент: Встреча: создать карточки людей из участников`
- `Ассистент: Применить офлайн-очередь`
- `Ассистент: Статус: Принято (в календаре, из заметки встречи)`
- `Ассистент: Статус: Отклонено (в календаре, из заметки встречи)`
- `Ассистент: Статус: Возможно (в календаре, из заметки встречи)`
- `Ассистент: Статус: Нет ответа (в календаре, из заметки встречи)`

### Диктофон (запись разговора)

- **Где лежат аудио-файлы**: `Ассистент/Записи/` (в vault).
- **Нарезка на файлы**: каждые `recording.chunkMinutes` минут (по умолчанию 5).
- **Авто запись**: по умолчанию **включена** (`recording.autoStartEnabled=true`) и использует таймер `recording.autoStartSeconds` (по умолчанию 5 секунд).
  - Семантика: если диктофон открыт на встрече, которая уже началась — в окне будет обратный отсчёт и авто‑нажатие REC.
  - Также: при уведомлении “в момент начала” плагин может открыть диктофон сразу (без отдельного окна напоминания).
- **Семантика паузы**:
  - “Пауза” **завершает текущий файл** (файл гарантированно дописывается).
  - “Продолжить” **начинает новый файл**.
- **Закрытие окна**: если запись идёт — она останавливается и текущий файл дописывается.
- **Протокол + файлы**:
  - если при старте записи создан “Новый протокол”, то каждый записанный файл автоматически добавляется в frontmatter протокола `files: [...]`.
- **Формат**: по умолчанию пишем аудио в `audio/webm` (обычно Opus). Настройки выбора формата нет (mp3 потребует отдельной конвертации после записи).

### Встречи: участники и статус

- В карточке встречи хранится список `attendees` (email + CN + PARTSTAT), а также агрегаты `attendees_*` (сколько “придёт/не придёт/не указал”).
- Поле `my_partstat` — это ваш статус участия из календаря (PARTSTAT/RSVP): Принято/Отклонено/Возможно/Нет ответа. В CalDAV его можно менять из повестки (write-back).

### Важно (git + приватные токены)

Если vault синхронизируется через git:

- **Не синхронизируй `.obsidian/`**. Это локальные настройки Obsidian (на разных установках/на телефоне могут быть другие плагины и другая конфигурация).
  - Рекомендуемый `.gitignore` для vault:
    - `.obsidian`
- **Настройки плагинов тоже должны быть локальными** (обычно лежат в `.obsidian/plugins/...`), например:
  - `<vault>/.obsidian/plugins/assistant/data.json` (там могут быть приватные ICS URL с токенами)
  - `<vault>/.obsidian/plugins/assistant/logs/` (лог‑файлы)

# Кейсы использования

## 1) Совещание (MVP сейчас)

- ✅ В календаре есть совещание на определённую дату (ICS/CalDAV).
- ✅ В повестке можно открыть карточку встречи по клику.
- ✅ За N минут показывается напоминание (настраивается).
- ✅ В момент начала можно открыть диктофон (и при включённой авто‑записи он стартует по таймеру).
- ✅ Для встречи можно создать/открыть протокол; по мере записи в протоколе появляются аудио‑файлы.
- ✅ Из участников можно создать карточки людей (если их ещё не было).

**Результат (MVP):**

- Повестка/уведомления/диктофон работают как “операционный слой” вокруг встречи.
- У встречи есть артефакты в vault (карточка встречи + протокол + файлы записи).

### 1.1) Следующий этап (план)

- ⏳ Транскрипция (ASR) + запись в протокол: “кто/когда/что сказал”.
- ⏳ Идентификация говорящих (voiceprint) и маппинг “голос → человек”.
- ⏳ Извлечение фактов/проектов/обещаний из транскрипта, создание/связи карточек.
- ⏳ Резюме встречи и (опционально) write‑back резюме в календарь, если у события есть права редактирования.
- ⏳ Политика хранения: авто‑удаление аудио после извлечения знаний (с явным UX подтверждением/retain).

## 2) Работа с календарём (MVP сейчас)

- ✅ Панель “Повестка”: текущий день, индикатор “сейчас”, список/сетка событий.
- ✅ Клик по событию открывает карточку встречи (md).
- ✅ Контекстное меню на событии: протоколы/диктофон/RSVP.
- ✅ RSVP write-back: можно отметить “Принято/Отклонено/Возможно/Нет ответа” и отправить в CalDAV.

### 2.1) Важно: Event vs Occurrence (серия vs конкретная дата)

Если редактируем “событие в целом” — это про **master** (series). Если редактируем “конкретную дату” — это про **экземпляр** (occurrence).

- Контракт ключей фиксируем в `FIELDS.md`:
  - **EventKey** = `calendar_id:event_id` (master)
  - **OccurrenceKey** = `calendar_id:event_id:start_ms` (экземпляр/дата)

### 2.2) Следующий этап (план)

- ⏳ Двусторонняя синхронизация полей события (summary/description/color) с календарём (с учётом прав и Event vs Occurrence).
- ⏳ Создание новых встреч из плагина (в MVP не обязательно, но полезно).

**Результат (цель):**

- Управление календарём прямо из Obsidian через “Ассистент” (в рамках разумного: RSVP/заметки/артефакты/обновления).

## 3) Работа с чатом

- Обсидиан это не только база встеч и расшифровок, это хранилище знаний, и разных. Например настройка linux или список художественных книг
- И с этой информацией можно работать как с кодом в курсоре
- С помощью различных LLM облачных, внутренних, платных, бесплатных + MCP информацию можно обрабатывать, задавать вопросы и находить решения
- В чате можно использовать готовые сценарии, начинается со "/" можно использовать контекст начинается с "@" работать с изображениями и даже кодом
- Через чат можно настраивать ОС а через MCP взаимодействовать с любыми инструментами

## 4) Работа с гугл документами

- Можно создать документ в мета информации указать источник и он подтянется в md разметке при обновление документа локальный тоже обновится
- В обратую сторону сторону только документы где я автор
- Это нужно что бы иметь общий контекст и знания
- Подумать каких еще документов это может касаться, таблиц презентаций, траниц вики и т.д.
