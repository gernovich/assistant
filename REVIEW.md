# Ревью Assistant (Obsidian plugin)

## Контекст (на сейчас)

- **Платформа**: Linux-only (см. `README.md`)
- **Запись**: `electron_media_devices` (микрофон) и `g_streamer` (GStreamer через `gst-kit` + отдельный Node worker)
- **Цель**: календарь → повестка → протоколы → запись → (дальше ASR/извлечение знаний)

## Сводка

- **Сильная база**: чёткие слои (Application/Domain/Presentation), DI, высокий уровень тестовой дисциплины.
- **Главные риски сейчас**: безопасность секретов, консистентность DTO (Event vs Occurrence), устойчивость записи (worker/Node ABI/timeout/конвертация уровней).
- **Статус тестов**: ✅ `npm test` проходит (последний прогон: **100 файлов / 438 тестов**).

---

## ✅ Что сделано хорошо

- **Архитектура**: понятный composition root (`src/plugin/pluginContext.ts`, `src/plugin/di/assistantContainer.ts`), use-case’ы в `src/application/*`, pure policies в `src/domain/policies/*`.
- **Запись**: state machine вынесена в `RecordingUseCase`, фасад аккуратно собирает параметры (`src/application/recording/recordingFacade.ts`).
- **Повестка**: `AgendaView` хорошо держит UX-петлю (stale banner, “прыжок” к ближайшей встрече, оптимистичный RSVP).
- **Настройки**: RAW schema через Zod + отдельная нормализация с дефолтами (`src/shared/validation/assistantSettingsSchema.ts`, `src/settingsStore.ts`).
- **Документация и ручное тестирование**: `README.md`, `TESTING.md` реально пригодны для прогона.

---

## ⚠️ Точки улучшения (приоритеты)

### P0 — критично

- **Секреты в `.obsidian/plugins/assistant/data.json`**
  - **Проблема**: там пароли/refresh_token; при ошибке в git-sync можно утечь.
  - **Улучшение**: в `README.md` и в UI настроек добавить явный “баннер безопасности” + чеклист “.obsidian НЕ в git”.
  - **Улучшение (дальше)**: рассмотреть хранение секретов через OS keyring (если будет нужно).

- **GStreamer worker может повесить остановку записи (нет таймаута на ожидание exit)**
  - **Проблема**: сейчас `finalizeCurrentFile()` ждёт `waitExit()` без таймаута — если worker завис, `pause/stop` могут зависнуть.
  - **Улучшение**: в backend добавить таймаут ожидания (например 3–5с) + принудительный kill при превышении + лог с диагностикой.

### P1 — важно

- **Единая политика “уровень → amp01” для всех бэкендов**
  - **Проблема**: сейчас `electron_media_devices` и `g_streamer` используют разные mapping’и (и есть риск “двойной гаммы” из-за UI).
  - **Улучшение**: завести **одну policy** (например `amp01FromDbfsPolicy`) в `src/domain/policies/recordingVizAmp.ts` и использовать её во всех бэкендах. UI (`recordingWindowHtml`) пусть делает только рисование/лёгкую визуальную гамму, но вход должен быть сравнимым.

- **Node ABI/версия для `gst-kit`**
  - **Проблема**: `gst-kit` — native addon; он должен быть собран под Node, которым запускается worker. Если `npm i` делали другой версией Node — worker может не загрузить `gst-kit`.
  - **Улучшение**:
    - в `checkGStreamerRecordingDependencies()` проверять не только `gst-launch-1.0`, но и **запуск worker** (require `gst-kit`) и выдавать понятный итог.
    - зафиксировать в `README.md` требование по Node для установки (или добавить шаг “rebuild gst-kit”).

- **`pluginDirPath` как критическая зависимость записи**
  - **Проблема**: worker-файл живёт в директории плагина, значит ошибка в определении `pluginDirPath` = запись не стартует.
  - **Улучшение**: в лог старта записи добавлять `pluginDirPath`, `workerPath`, `nodeBinary`, и при отсутствии — показывать понятную ошибку в UI.

- **Event vs Occurrence**
  - **Проблема**: в `src/types.ts` уже есть комментарий, что Occurrence нужен как отдельный контракт.
  - **Улучшение**: сделать явный DTO `Occurrence` (и минимальные helpers), чтобы не путать “серийное событие” и “экземпляр по дате” в write-back/протоколах/записи.

### P2 — полезно

- **Настройки: подготовить миграции**
  - **Проблема**: сейчас есть обратная совместимость кусками, но нет версии схемы.
  - **Улучшение**: добавить `settingsVersion` и таблицу миграций в `normalizeSettings()` (даже если пока пустая).

- **Повестка: микро-оптимизации рендера**
  - **Проблема**: `render()` пересоздаёт DOM целиком; на больших списках может быть заметно.
  - **Улучшение**: оставить как есть до появления реальной боли; если появится — перейти на частичный update (blocks diff) или ограничить перерисовку только изменившихся частей.

---

## Запись звука (детально)

- **Слои**:
  - `RecordingUseCase` — state machine чанков/паузы/стопа.
  - `RecordingFacade` — собирает параметры из настроек.
  - `useCaseBackends` — реальные backend реализации.
- **GStreamer**:
  - Плюс: изоляция `gst-kit` в отдельный Node worker.
  - Минусы/риски: timeout на exit, Node ABI, логирование “почему не стартануло”.
- **Electron Media Devices**:
  - Сейчас пишется только микрофон, что соответствует текущему UX/требованию.
  - Возможное улучшение: контроль ошибок `MediaRecorder` (события `error`/`stop`) в логе.

---

## Повестка (детально)

- Хороший UX: баннер stale, быстрые действия (перейти/протокол/диктофон), оптимистичный RSVP.
- Риск: “всё в одном render” — держим как P2, пока maxEvents=50 и это не болит.

---

## Настройки/DTO (детально)

- **Хорошо**: RAW schema (strict) + нормализация и ограничения значений.
- **Улучшить**: версионирование настроек и явный Occurrence DTO.
- **Безопасность**: ещё раз — явный safety banner обязателен (P0).

---

## Предложение по ближайшему Roadmap (коротко)

- **P0**: таймауты/kill для worker + safety banner по секретам.
- **P1**: единая политика amp01 + проверка worker/gst-kit в deps-check + явный Occurrence DTO.
- **P2**: settingsVersion + при необходимости оптимизация повестки.

---

**Дата ревью:** 2026-01-27  
**Версия:** 0.0.1
